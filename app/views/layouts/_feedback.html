<section class="dfe-feedback">
    <div class="govuk-width-container">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <div class="dfe-feedback-banner">
                    <div class="dfe-feedback-banner--content">
                        <div class="dfe-feedback-banner--flex">
                            <h2 class="govuk-heading-s">Tell us what you think of this page</h2>
                            <button type="button" class="govuk-button" data-module="govuk-button"
                                id="problemButton">Give feedback</button>
                        </div>

                        <div class="dfe-feedback-banner--content-message" id="thanksMessage" role="status" hidden>
                            Thank you for your feedback
                        </div>

                        <div class="dfe-feedback-panel" id="feedback-panel" style="display: none;" aria-hidden="true">
                            <form id="feedback-form">
                                <div class="govuk-character-count" data-module="govuk-character-count"
                                    data-maxlength="400">
                                    <div class="govuk-form-group">
                                        <h3 class="govuk-label-wrapper">
                                            <label class="govuk-label govuk-label--m" for="feedback_form_input">
                                                Can you provide more detail?
                                            </label>
                                        </h3>
                                        <textarea class="govuk-textarea govuk-js-character-count"
                                            id="feedback_form_input" name="feedback_form_input" rows="5"
                                            aria-describedby="feedback_form_input"></textarea>
                                        <div id="feedback_form_input-info"
                                            class="govuk-hint govuk-character-count__message">
                                            You can enter up to 400 characters
                                        </div>
                                    </div>
                                </div>
                                <div class="govuk-button-group">
                                    <button class="govuk-button" data-module="govuk-button" type="submit">
                                        Submit
                                    </button>
                                    <button class="govuk-button govuk-button--secondary" type="button"
                                        data-module="govuk-button" id="cancelButton">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const problemButton = document.getElementById('problemButton');
        const cancelButton = document.getElementById('cancelButton');
        const feedbackPanel = document.getElementById('feedback-panel');
        const thanksMessage = document.getElementById('thanksMessage');
        const feedbackHeading = document.querySelector('.govuk-heading-s'); // Target the heading
        const feedbackForm = document.getElementById('feedback-form'); // Correct form selector

        // Show feedback panel when clicking "Give feedback"
        problemButton.addEventListener('click', function () {
            feedbackPanel.style.display = 'block';
            problemButton.style.display = 'none'; // Hide the button
            feedbackHeading.style.display = 'none'; // Hide the heading
        });

        // Hide feedback panel when clicking "Cancel"
        cancelButton.addEventListener('click', function () {
            feedbackPanel.style.display = 'none';
            problemButton.style.display = 'block'; // Show the button again
            feedbackHeading.style.display = 'block'; // Show the heading again
            thanksMessage.hidden = true; // Ensure the thank you message is hidden
        });

        // Handle form submission
        feedbackForm.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission

            const feedbackInput = document
                .getElementById('feedback_form_input')
                .value
                .trim();

            if (feedbackInput === '') {
                alert("Please provide some feedback before submitting.");
                return;
            }

            submitDetailedFeedback(feedbackInput);
        });

        function submitDetailedFeedback(feedback) {
            fetch('/form-response/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({response: feedback}) // Ensure the correct key
            })
                .then(response => {
                    if (!response.ok) {
                        return response
                            .json()
                            .then(errData => {
                                throw new Error(errData.message || `HTTP error! Status: ${response.status}`);
                            });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Success:', data);
                    thanksMessage.hidden = false; // Show the thank you message
                    feedbackPanel.style.display = 'none'; // Hide the form
                    problemButton.style.display = 'block'; // Show the original button again
                    feedbackHeading.style.display = 'block'; // Restore heading visibility
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert(`Error submitting feedback: ${error.message}`);
                });
        }
    });
</script>